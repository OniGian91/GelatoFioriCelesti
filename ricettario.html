<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiori Celesti - Ricettario</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .back-button {
            display: inline-block;
            margin-bottom: 25px;
        }

        .search-filter {
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .top-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .back-button {
            flex-shrink: 0;
        }

        .stats-container {
            display: flex;
            gap: 15px;
            flex: 1;
            justify-content: flex-end;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2px;
            line-height: 1;
        }

        .stat-label {
            color: var(--text-color);
            font-size: 0.8rem;
            line-height: 1;
        }

        .search-filter input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-filter input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-filter .search-icon {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .my-recipes-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            color: #2c3e50;
            white-space: nowrap;
        }

        .my-recipes-filter:hover {
            background: #d5dbdb;
            border-color: #95a5a6;
        }

        .my-recipes-filter.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .my-recipes-filter.active:hover {
            background: #5568d3;
            border-color: #5568d3;
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .recipe-card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            page-break-inside: avoid;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .recipe-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
        }

        .recipe-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .recipe-title-text {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .recipe-title-text .flavor-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .load-recipe-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .load-recipe-btn:hover {
            background: #229954;
            transform: scale(1.1);
        }

        .recipe-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.9;
            flex-wrap: wrap;
            gap: 8px;
        }

        .recipe-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .recipe-body {
            padding: 15px;
        }

        .recipe-section {
            margin-bottom: 15px;
        }

        .recipe-section:last-child {
            margin-bottom: 0;
        }

        .recipe-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ingredients-list {
            list-style: none;
            padding: 0;
        }

        .ingredient-list-item {
            padding: 8px 12px;
            background: white;
            border-radius: 5px;
            margin-bottom: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.85rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ingredient-list-item:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .ingredient-name {
            font-weight: 500;
            color: var(--text-color);
            flex: 1;
        }

        .ingredient-weight {
            font-weight: 700;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .nutrition-item {
            background: rgba(102, 126, 234, 0.05);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .nutrition-label {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .nutrition-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .property-item {
            background: rgba(102, 126, 234, 0.05);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .property-label {
            font-size: 0.65rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .property-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.2;
        }

        .property-status {
            font-size: 0.65rem;
            margin-top: 2px;
            line-height: 1;
        }

        .status-optimal {
            color: #27ae60;
        }

        .status-warning {
            color: #f39c12;
        }

        .status-error {
            color: #e74c3c;
        }

        .ingredients-blocks {
            display: flex;
            width: 100%;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .ingredient-block {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
            padding: 5px;
        }

        .ingredient-block:hover {
            filter: brightness(1.1);
        }

        .block-name {
            display: block;
            font-size: 0.75rem;
        }

        .block-weight {
            display: block;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-color);
            opacity: 0.6;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h2 {
            margin: 0;
        }

        /* Nascondi search-filter quando non ci sono ricette */
        .no-recipes .search-filter {
            display: none;
        }

        .recipe-actions {
            display: flex;
            gap: 8px;
        }

        .delete-recipe-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .delete-recipe-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .edit-recipe-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .edit-recipe-btn:hover {
            background: #e67e22;
            transform: scale(1.1);
        }

        .total-weight-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .hidden {
            display: none !important;
        }

        .no-user-info {
            display: flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            .recipes-grid {
                grid-template-columns: 1fr;
            }

            .nutrition-grid {
                grid-template-columns: 1fr;
            }

            .properties-grid {
                grid-template-columns: 1fr;
            }

            .recipe-title {
                flex-direction: column;
                align-items: flex-start;
            }

            .recipe-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media print {
            .recipe-card {
                page-break-inside: avoid;
                margin-bottom: 30px;
                box-shadow: none;
                border: 1px solid #ddd;
            }

            .back-button,
            .search-filter {
                display: none;
            }

            header {
                display: none;
            }

            .recipe-card:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <a href="index.html" style="display: inline-block; cursor: pointer;">
                    <img src="imgs/logo.jpg" alt="Logo Fiori Celesti" class="logo" style="cursor: pointer;">
                </a>
                <div class="header-text">
                    <h1>Fiori Celesti</h1>
                    <p class="subtitle">Ricettario Gelati</p>
                </div>
            </div>
            <div class="header-right">
                <!-- Info utente loggato -->
                <div class="user-info hidden" id="user-info">
                    <img src="imgs/logged_user.png" alt="User" class="user-icon">
                    <span class="username-display" id="username-display"></span>
                    <button id="logout-btn" class="btn-logout" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <div class="no-user-info" id="no-user-info">
                    <p style="color: #7f8c8d; font-size: 0.9rem;">Accedi dalla pagina principale</p>
                </div>
            </div>
        </header>

        <main>
            <div class="top-section">
                <a href="index.html" class="back-button btn-secondary">
                    <i class="fas fa-arrow-left"></i> Torna alla Home
                </a>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="total-recipes">0</div>
                        <div class="stat-label">Ricette Totali</div>
                    </div>
                </div>
            </div>

            <div class="search-filter">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Cerca ricetta per nome gelato...">
                <button id="clear-search" class="btn-secondary" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
                <button class="my-recipes-filter" id="my-recipes-filter">
                    <i class="fas fa-user-check"></i>
                    Create da me
                </button>
            </div>

            <div id="recipes-container" class="recipes-grid"></div>
        </main>

        <footer>
            <p>&copy; 2026 Gelateria Fiori Celesti</p>
        </footer>
    </div>

    <!-- Modal Ingrediente -->
    <div id="ingredient-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <img id="modal-ingredient-image" class="modal-ingredient-image" src="" alt="Ingredient" onerror="this.src='imgs/ingredients/default.png'">
            <h2 id="modal-ingredient-name"></h2>
            <p id="modal-ingredient-help" class="modal-ingredient-help"></p>
            <div class="modal-data-grid">
                <div class="modal-data-item">
                    <span class="modal-label">Acqua:</span>
                    <span class="modal-value" id="modal-water"></span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-label">Zuccheri:</span>
                    <span class="modal-value" id="modal-sugars"></span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-label">Grassi:</span>
                    <span class="modal-value" id="modal-fats"></span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-label">Proteine (SLNG):</span>
                    <span class="modal-value" id="modal-proteins"></span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-label">Altri solidi:</span>
                    <span class="modal-value" id="modal-other-solids"></span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-label">POD:</span>
                    <span class="modal-value" id="modal-pod"></span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-label">PAC:</span>
                    <span class="modal-value" id="modal-pac"></span>
                </div>
            </div>
        </div>
    </div>

    <script src="ingredientsDB.js"></script>
    <script>
        let allRecipes = [];
        let filteredRecipes = [];
        let showOnlyMyRecipes = false;
        let currentLoggedUser = null;

        // Carica e visualizza tutte le ricette
        function loadRecipes() {
            allRecipes = JSON.parse(localStorage.getItem('gelatoHistory') || '[]');
            filteredRecipes = [...allRecipes];
            
            // Controlla utente loggato
            checkUser();
            
            displayRecipes();
        }

        // Controlla se c'è un utente loggato
        function checkUser() {
            const savedUsername = localStorage.getItem('gelatoUserName');
            
            if (savedUsername) {
                currentLoggedUser = savedUsername;
                document.getElementById('username-display').textContent = savedUsername;
                const userIcon = document.querySelector('.user-icon');
                userIcon.src = `imgs/${savedUsername}.png`;
                userIcon.onerror = function() { this.src = 'imgs/logged_user.png'; };
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('no-user-info').classList.add('hidden');
            } else {
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('no-user-info').classList.remove('hidden');
            }
        }

        // Visualizza le ricette
        function displayRecipes() {
            const container = document.getElementById('recipes-container');
            const main = document.querySelector('main');
            
            // Aggiorna il contatore delle ricette totali
            document.getElementById('total-recipes').textContent = allRecipes.length;

            if (filteredRecipes.length === 0) {
                if (allRecipes.length === 0) {
                    main.classList.add('no-recipes');
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-ice-cream"></i>
                            <h2>Nessuna ricetta salvata</h2>
                        </div>
                    `;
                } else {
                    main.classList.remove('no-recipes');
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h2>Nessuna ricetta trovata</h2>
                        </div>
                    `;
                }
                return;
            }

            main.classList.remove('no-recipes');

            // Genera le card delle ricette
            container.innerHTML = filteredRecipes.map((recipe, index) => {
                // Trova l'indice originale nella lista completa
                const originalIndex = allRecipes.findIndex(r => r.date === recipe.date);
                return generateRecipeCard(recipe, originalIndex);
            }).join('');
        }

        // Filtra le ricette per nome e/o utente
        function filterRecipes(searchTerm) {
            const term = searchTerm ? searchTerm.toLowerCase().trim() : '';
            
            filteredRecipes = allRecipes.filter(recipe => {
                // Filtro per testo di ricerca
                const matchesSearch = !term || recipe.flavorName.toLowerCase().includes(term);
                
                // Filtro "Create da me" (case-insensitive)
                const matchesUser = !showOnlyMyRecipes || 
                    (recipe.userName && currentLoggedUser && 
                     recipe.userName.toLowerCase() === currentLoggedUser.toLowerCase());
                
                return matchesSearch && matchesUser;
            });
            
            displayRecipes();
        }

        // Colori per gli ingredienti
        const ingredientColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
            '#FF8FA3', '#C9ADA7', '#A8DADC', '#F4A261', '#E9C46A',
            '#2A9D8F', '#E76F51', '#8E7DBE', '#F4978E', '#84A59D'
        ];

        // Genera un colore consistente basato sul nome dell'ingrediente
        function getIngredientColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % ingredientColors.length;
            return ingredientColors[index];
        }

        // Genera una card per una ricetta
        function generateRecipeCard(recipe, index) {
            const date = new Date(recipe.date);
            const dateStr = date.toLocaleDateString('it-IT', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Calcola i totali nutrizionali
            const totals = calculateRecipeTotals(recipe.recipe);
            
            // Ordina gli ingredienti per peso (dal più pesante al più leggero)
            const sortedIngredients = [...recipe.recipe].sort((a, b) => b.weight - a.weight);
            
            // Genera la lista degli ingredienti
            const ingredientsHTML = sortedIngredients.map(item => {
                const imageName = ingredientsDB[item.name]?.img || 'default';
                return `
                    <li class="ingredient-list-item">
                        <img src="imgs/ingredients/${imageName}.png" class="ingredient-icon" alt="${item.name}" onerror="this.src='imgs/ingredients/default.png'">
                        <span class="ingredient-name" style="cursor: pointer;" onclick="showIngredientModal('${item.name.replace(/'/g, "\\'")}')")" title="Clicca per vedere i dettagli">${item.name}</span>
                        <span class="ingredient-weight">${item.weight} g</span>
                    </li>
                `;
            }).join('');

            // Stato solidi totali
            const solidsStatus = getSolidsStatus(totals.totalSolidsPercent);
            const solidsClass = solidsStatus.includes('✓') ? 'status-optimal' : 
                               solidsStatus.includes('⚠') ? 'status-warning' : 'status-error';
            
            // Stato grassi
            const fatsStatus = getFatsStatus(totals.fatsPercent);
            const fatsClass = fatsStatus.includes('✓') ? 'status-optimal' : 
                            fatsStatus.includes('⚠') ? 'status-warning' : 'status-error';

            return `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <div class="recipe-title">
                            <div class="recipe-title-text" title="${recipe.flavorName}">
                                <i class="fas fa-ice-cream" style="flex-shrink: 0;"></i>
                                <span class="flavor-text">${recipe.flavorName}</span>
                            </div>
                            <div class="recipe-actions">
                                <button class="load-recipe-btn" onclick="viewRecipeDetail(${index})" title="Visualizza ricetta">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="edit-recipe-btn" onclick="renameRecipe(${index})" title="Rinomina ricetta">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-recipe-btn" onclick="deleteRecipe(${index})" title="Elimina ricetta">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="recipe-meta">
                            <div class="recipe-meta-item">
                                <img src="imgs/${recipe.userName}.png" onerror="this.src='imgs/logged_user.png'" class="user-avatar" alt="${recipe.userName}">
                                ${recipe.userName}
                            </div>
                            <div class="recipe-meta-item">
                                <i class="fas fa-calendar"></i>
                                ${dateStr}
                            </div>
                            <div class="recipe-meta-item">
                                <span class="total-weight-badge">
                                    <i class="fas fa-weight"></i>
                                    ${totals.totalWeight.toFixed(1)} g
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recipe-body">
                        <!-- Lista ingredienti -->
                        <div class="recipe-section">
                            <div class="recipe-section-title">
                                <i class="fas fa-list"></i>
                                Ingredienti (${recipe.recipe.length})
                            </div>
                            <ul class="ingredients-list">
                                ${ingredientsHTML}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // Genera i blocchi colorati degli ingredienti
        function generateIngredientsBlocks(recipe) {
            if (recipe.length === 0) return '';

            const totalWeight = recipe.reduce((sum, item) => sum + item.weight, 0);
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
                '#FF8FA3', '#C9ADA7', '#A8DADC', '#F4A261', '#E9C46A',
                '#2A9D8F', '#E76F51', '#8E7DBE', '#F4978E', '#84A59D'
            ];

            const blocks = recipe.map((item, index) => {
                const percentage = (item.weight / totalWeight * 100).toFixed(1);
                const color = colors[index % colors.length];
                const ingredient = ingredientsDB[item.name];
                const imageName = ingredient?.img || 'default';
                return `
                    <div class="ingredient-block" 
                         style="flex-grow: ${item.weight}; background-color: ${color}; cursor: pointer;" 
                         onclick="showIngredientModal('${item.name.replace(/'/g, "\\'")}')"
                         title="Clicca per vedere i dettagli di ${item.name}">
                        <img src="imgs/ingredients/${imageName}.png" class="ingredient-block-icon" alt="${item.name}" onerror="this.style.display='none'">
                        <div>
                            <span class="block-name">${item.name}</span>
                            <span class="block-weight">${percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            return `<div class="ingredients-blocks">${blocks}</div>`;
        }

        // Calcola i totali nutrizionali per una ricetta
        function calculateRecipeTotals(recipe) {
            let totalWeight = 0;
            let water = 0, sugars = 0, fats = 0, proteins = 0, otherSolids = 0;
            let pod = 0, pac = 0;

            recipe.forEach(item => {
                const ingredient = ingredientsDB[item.name];
                if (!ingredient) return;
                
                const factor = item.weight / 100;
                
                totalWeight += item.weight;
                water += ingredient.water * factor;
                sugars += ingredient.sugars * factor;
                fats += ingredient.fats * factor;
                proteins += ingredient.proteins * factor;
                otherSolids += ingredient.otherSolids * factor;
                pod += ingredient.pod * factor;
                pac += ingredient.pac * factor;
            });

            const waterPercent = totalWeight > 0 ? (water / totalWeight) * 100 : 0;
            const sugarsPercent = totalWeight > 0 ? (sugars / totalWeight) * 100 : 0;
            const fatsPercent = totalWeight > 0 ? (fats / totalWeight) * 100 : 0;
            const proteinsPercent = totalWeight > 0 ? (proteins / totalWeight) * 100 : 0;
            const otherSolidsPercent = totalWeight > 0 ? (otherSolids / totalWeight) * 100 : 0;
            const totalSolidsPercent = 100 - waterPercent;

            return {
                totalWeight,
                water, sugars, fats, proteins, otherSolids,
                waterPercent, sugarsPercent, fatsPercent, proteinsPercent, otherSolidsPercent,
                totalSolidsPercent,
                pod, pac
            };
        }

        // Valuta lo stato dei solidi totali
        function getSolidsStatus(percent) {
            if (percent >= 36 && percent <= 42) return '✓ Ottimale';
            if (percent >= 33 && percent < 36) return '⚠ Basso';
            if (percent > 42 && percent <= 45) return '⚠ Alto';
            if (percent < 33) return '✗ Troppo basso';
            return '✗ Troppo alto';
        }

        // Valuta lo stato dei grassi
        function getFatsStatus(percent) {
            if (percent >= 6 && percent <= 10) return '✓ Ottimale';
            if (percent >= 4 && percent < 6) return '⚠ Basso';
            if (percent > 10 && percent <= 12) return '⚠ Alto';
            if (percent < 4) return '✗ Troppo basso';
            return '✗ Troppo alto';
        }

        // Visualizza i dettagli di una ricetta
        function viewRecipeDetail(index) {
            window.location.href = `ricetta.html?index=${index}`;
        }

        // Carica una ricetta nel calcolatore
        function loadRecipeIntoCalculator(index) {
            const recipes = JSON.parse(localStorage.getItem('gelatoHistory') || '[]');
            const recipe = recipes[index];
            
            if (!recipe) {
                alert('Ricetta non trovata!');
                return;
            }

            // Salva la ricetta da caricare in localStorage
            localStorage.setItem('gelatoRecipeToLoad', JSON.stringify({
                flavorName: recipe.flavorName,
                recipe: recipe.recipe,
                userName: recipe.userName
            }));

            // Reindirizza alla pagina di preparazione
            window.location.href = 'preparazione.html';
        }

        // Elimina una ricetta
        // Rinomina una ricetta
        function renameRecipe(index) {
            const recipes = JSON.parse(localStorage.getItem('gelatoHistory') || '[]');
            
            if (index < 0 || index >= recipes.length) {
                alert('Ricetta non trovata.');
                return;
            }

            const recipe = recipes[index];
            const newName = prompt('Inserisci il nuovo nome per il gelato:', recipe.flavorName);
            
            if (newName && newName.trim() !== '') {
                recipe.flavorName = newName.trim();
                localStorage.setItem('gelatoHistory', JSON.stringify(recipes));
                
                // Ricarica le ricette
                loadRecipes();
            }
        }

        function deleteRecipe(index) {
            if (!confirm('Sei sicuro di voler eliminare questa ricetta?')) {
                return;
            }

            const recipes = JSON.parse(localStorage.getItem('gelatoHistory') || '[]');
            
            if (index >= 0 && index < recipes.length) {
                recipes.splice(index, 1);
                localStorage.setItem('gelatoHistory', JSON.stringify(recipes));
                
                // Ricarica le ricette
                loadRecipes();
            }
        }

        // Controlla se c'è un utente loggato
        function checkSavedUser() {
            const savedUser = localStorage.getItem('gelatoUserName');
            
            if (savedUser) {
                currentLoggedUser = savedUser;
                document.getElementById('username-display').textContent = savedUser;
                const userIcon = document.querySelector('.user-icon');
                userIcon.src = `imgs/${savedUser}.png`;
                userIcon.onerror = function() { this.src = 'imgs/logged_user.png'; };
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('no-user-info').classList.add('hidden');
                document.querySelector('main').classList.remove('hidden');
            } else {
                // Nessun utente loggato - nascondi il contenuto
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('no-user-info').classList.remove('hidden');
                document.querySelector('main').classList.add('hidden');
                alert('Devi effettuare il login per accedere al ricettario. Torna alla home page per fare il login.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // Gestisce il logout
        function handleLogout() {
            if (confirm('Vuoi effettuare il logout?')) {
                localStorage.removeItem('gelatoUserName');
                window.location.href = 'index.html';
            }
        }

        // Inizializza la pagina
        window.addEventListener('DOMContentLoaded', () => {
            checkSavedUser();
            loadRecipes();
            
            // Setup del logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // Setup del filtro di ricerca
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.addEventListener('input', (e) => {
                const value = e.target.value;
                filterRecipes(value);
                clearBtn.style.display = value ? 'block' : 'none';
            });
            
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterRecipes('');
                clearBtn.style.display = 'none';
                searchInput.focus();
            });

            // Setup del filtro "Create da me"
            const myRecipesFilter = document.getElementById('my-recipes-filter');
            myRecipesFilter.addEventListener('click', () => {
                showOnlyMyRecipes = !showOnlyMyRecipes;
                myRecipesFilter.classList.toggle('active');
                filterRecipes(searchInput.value);
            });

            // Setup modale ingrediente
            const modal = document.getElementById('ingredient-modal');
            const closeBtn = document.querySelector('.modal-close');
            
            closeBtn.addEventListener('click', closeIngredientModal);
            
            // Chiudi cliccando fuori
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeIngredientModal();
                }
            });
        });

        // Mostra il modale con i dettagli dell'ingrediente
        function showIngredientModal(ingredientName) {
            const ingredient = ingredientsDB[ingredientName];
            
            if (!ingredient) {
                console.error('Ingrediente non trovato:', ingredientName);
                return;
            }
            
            // Popola il modale
            document.getElementById('modal-ingredient-image').src = `imgs/ingredients/${ingredient.img || 'default'}.png`;
            document.getElementById('modal-ingredient-name').textContent = ingredientName;
            document.getElementById('modal-ingredient-help').textContent = ingredient.help || 'Nessuna descrizione disponibile.';
            document.getElementById('modal-water').textContent = `${ingredient.water.toFixed(1)}%`;
            document.getElementById('modal-sugars').textContent = `${ingredient.sugars.toFixed(1)}%`;
            document.getElementById('modal-fats').textContent = `${ingredient.fats.toFixed(1)}%`;
            document.getElementById('modal-proteins').textContent = `${ingredient.proteins.toFixed(1)}%`;
            document.getElementById('modal-other-solids').textContent = `${ingredient.otherSolids.toFixed(1)}%`;
            document.getElementById('modal-pod').textContent = ingredient.pod.toFixed(1);
            document.getElementById('modal-pac').textContent = ingredient.pac.toFixed(1);
            
            // Mostra il modale
            const modal = document.getElementById('ingredient-modal');
            modal.style.display = 'block';
        }

        // Chiudi il modale
        function closeIngredientModal() {
            const modal = document.getElementById('ingredient-modal');
            modal.style.display = 'none';
        }
    </script>
</body>
</html>
